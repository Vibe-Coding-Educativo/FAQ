<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de FAQ con IA</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --primary-color: #3498db; --success-color: #2ecc71; --danger-color: #e74c3c; --warning-color: #f39c12; --light-gray: #f4f7f9; --dark-gray: #333; --border-color: #ddd; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--light-gray); color: var(--dark-gray); margin: 0; padding: 2rem; }
        .container { width: 100%; max-width: 900px; margin: 0 auto; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        h1, h2, p { text-align: center; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: bold; margin-bottom: 0.5rem; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; margin-top: 0.5rem; color: white; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .loader { text-align: center; margin: 1.5rem 0; display: none; }
        .result-message { text-align: center; padding: 1rem; margin-top: 1rem; border-radius: 4px; display: none; }
        .result-message.success { background-color: #e6f4ea; color: #2d6a4f; }
        .result-message.error { background-color: #fbe9e7; color: #c62828; }
        .tag-input-container { display: flex; gap: 0.5rem; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; margin-top: 0.5rem; min-height: 40px; }
        .tag { display: flex; align-items: center; background-color: #e0e0e0; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; }
        .tag .remove-tag { margin-left: 8px; cursor: pointer; font-weight: bold; }
        nav { display: flex; justify-content: center; border-bottom: 2px solid var(--border-color); margin-bottom: 2rem; }
        .nav-button { background: none; border: none; color: var(--dark-gray); padding: 1rem; font-size: 1.1rem; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .nav-button.active { border-bottom-color: var(--primary-color); font-weight: bold; color: var(--primary-color); }
        .view { display: none; }
        .view.active { display: block; }
        .tabs { display: flex; justify-content: center; border-bottom: 2px solid #eee; margin-bottom: 2rem; }
        .tab-button { background: none; border: none; padding: 1rem; font-size: 1rem; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; color: var(--dark-gray); }
        .tab-button.active { border-bottom-color: var(--primary-color); font-weight: bold; color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #faq-list-container { margin-top: 1rem; }
        .faq-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; }
        .faq-item:last-child { border-bottom: none; }
        .faq-item p { text-align: left; margin: 0; flex-grow: 1; }
        .faq-item-buttons { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .faq-item-buttons button { width: auto; font-size: 0.9rem; padding: 6px 12px; background-color: var(--warning-color); }
        .faq-item-buttons button.delete { background-color: var(--danger-color); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .modal-buttons { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }
        .modal-buttons button { width: auto; }
        #modal-save { background-color: var(--success-color); }
        #modal-cancel { background-color: #7f8c8d; }
        .markdown-editor-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        #modal-respuesta, #reviewRespuesta { height: 250px; resize: vertical; }
        #modal-markdown-preview, #markdown-preview { border: 1px solid var(--border-color); border-radius: 4px; padding: 10px; height: 250px; overflow-y: auto; background-color: #fafafa; }
        #modal-markdown-preview * , #markdown-preview * { text-align: left !important; }
        #userInput, #categorize-question, #categorize-answer { height: 120px; resize: vertical; }
        #duplicate-alert { background-color: #fffbe6; border-color: #ffe58f; padding: 1.5rem; border-radius: 8px; border: 1px solid #ffe58f; }
        .duplicate-content { border: 1px solid #ddd; padding: 1rem; margin-top: 0.5rem; border-radius: 4px; background-color: #fff; }
        .duplicate-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; }
        #categorize-only-section { display: none; }
        .refine-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px dashed #ccc;}
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .checkbox-group label { margin-bottom: 0; font-weight: normal; }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <button class="nav-button active" data-view="add-view">Añadir FAQ</button>
            <button class="nav-button" data-view="manage-view">Gestionar FAQs</button>
        </nav>
        
        <main id="add-view" class="view active">
            <div class="tabs">
                <button class="tab-button active" data-tab="single">Entrada Individual</button>
                <button class="tab-button" data-tab="bulk">Entrada Múltiple</button>
            </div>

            <div id="single-entry-tab" class="tab-content active">
                <div id="generate-section">
                    <div class="checkbox-group">
                        <input type="checkbox" id="categorizeOnlyCheckbox">
                        <label for="categorizeOnlyCheckbox">Mantener mi texto y solo añadir categorías/palabras clave</label>
                    </div>
                    <div id="normal-generation-section">
                        <div class="form-group">
                            <label for="userInput">Idea o tema a desarrollar:</label>
                            <textarea id="userInput" placeholder="Escribe aquí una idea general para que la IA la desarrolle..."></textarea>
                        </div>
                    </div>
                    <div id="categorize-only-section">
                        <div class="form-group">
                            <label for="categorize-question">Pregunta (texto final):</label>
                            <textarea id="categorize-question"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="categorize-answer">Respuesta (texto final):</label>
                            <textarea id="categorize-answer"></textarea>
                        </div>
                    </div>
                    <button id="generateBtn" style="background-color: var(--primary-color);">Generar Sugerencia</button>
                </div>
            </div>

            <div id="bulk-entry-tab" class="tab-content">
                 <div class="form-group">
                    <label for="bulkInput">Pegar preguntas y respuestas en bloque</label>
                    <p style="text-align: left; font-size: 0.9em; margin-top: -0.5rem; margin-bottom: 0.5rem;">Usa el formato: "P: [pregunta]", "R: [respuesta]", y "---" para separar cada entrada.</p>
                    <textarea id="bulkInput" style="height: 300px;" placeholder="P: ¿Qué es HTML?&#10;R: Es un lenguaje de marcado.&#10;---&#10;P: ¿Qué es CSS?&#10;R: Es un lenguaje de estilos."></textarea>
                </div>
                <button id="bulkProcessBtn" style="background-color: var(--primary-color);">Procesar y Añadir en Bloque</button>
            </div>

            <div id="duplicate-alert" style="display: none;">
                <h2>⚠️ Posible Duplicado Encontrado</h2>
                <p>La IA cree que tu idea es muy similar a una pregunta que ya existe.</p>
                <div class="form-group">
                    <label>Pregunta Existente:</label>
                    <div class="duplicate-content" id="existing-question"></div>
                </div>
                <div class="form-group">
                    <label>Nueva Sugerencia de la IA:</label>
                    <div class="duplicate-content" id="suggested-question"></div>
                </div>
                <p>¿Qué quieres hacer?</p>
                <div class="duplicate-buttons">
                    <button id="replaceBtn" style="background-color: var(--warning-color);">Revisar y Reemplazar</button>
                    <button id="discardBtn" style="background-color: var(--danger-color);">Dejar la antigua (descartar sugerencia)</button>
                </div>
            </div>

            <div id="review-form" style="display: none;">
                <h2>Revisa la sugerencia de la IA</h2>
                <div class="form-group">
                    <label for="reviewPregunta">Pregunta</label>
                    <input type="text" id="reviewPregunta">
                </div>
                <div class="form-group">
                    <label for="reviewRespuesta">Respuesta (compatible con Markdown)</label>
                    <div class="markdown-editor-container">
                        <textarea id="reviewRespuesta"></textarea>
                        <div id="markdown-preview"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="addCategoriaInput">Categorías</label>
                    <div class="tag-input-container">
                        <input type="text" id="addCategoriaInput" placeholder="Añadir y pulsar Enter...">
                    </div>
                    <div class="tag-container" id="categoriasContainer"></div>
                </div>
                <div class="form-group">
                    <label for="addPalabraClaveInput">Palabras Clave</label>
                     <div class="tag-input-container">
                        <input type="text" id="addPalabraClaveInput" placeholder="Añadir y pulsar Enter...">
                    </div>
                    <div class="tag-container" id="palabrasClaveContainer"></div>
                </div>
                <div class="refine-section">
                    <div class="form-group">
                        <label for="refinementInput">¿Quieres mejorar algo? Da una instrucción:</label>
                        <input type="text" id="refinementInput" placeholder="Ej: 'haz la respuesta más corta', 'usa un tono más formal', 'añade un ejemplo de código'">
                    </div>
                    <button id="refineBtn" style="background-color: var(--warning-color);">Refinar con IA</button>
                </div>
                <button id="addBtn" style="background-color: var(--success-color);">Aprobar y Añadir a la Hoja de Cálculo</button>
            </div>
        </main>

        <main id="manage-view" class="view">
            <h2>Gestionar FAQs Existentes</h2>
            <input type="text" id="searchInput" placeholder="Buscar por pregunta, respuesta o categoría...">
            <div id="faq-list-container"></div>
        </main>
        
        <div class="loader" id="loader">🧠 Pensando...</div>
        <div id="result" class="result-message"></div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <h2>Editar FAQ</h2>
            <input type="hidden" id="modal-row-number">
            <div class="form-group">
                <label for="modal-pregunta">Pregunta</label>
                <input type="text" id="modal-pregunta">
            </div>
            <div class="form-group">
                <label for="modal-respuesta">Respuesta (Markdown)</label>
                <div class="markdown-editor-container">
                    <textarea id="modal-respuesta"></textarea>
                    <div id="modal-markdown-preview"></div>
                </div>
            </div>
            <div class="form-group">
                <label for="modal-add-categoria">Categorías</label>
                <div class="tag-input-container">
                    <input type="text" id="modal-add-categoria" placeholder="Añadir y pulsar Enter...">
                </div>
                <div class="tag-container" id="modal-categorias-container"></div>
            </div>
            <div class="form-group">
                <label for="modal-add-palabraclave">Palabras Clave</label>
                <div class="tag-input-container">
                    <input type="text" id="modal-add-palabraclave" placeholder="Añadir y pulsar Enter...">
                </div>
                <div class="tag-container" id="modal-palabrasclave-container"></div>
            </div>
            <div class="modal-buttons">
                <button id="modal-cancel">Cancelar</button>
                <button id="modal-save">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyuUrtNb72Faij5gp7qtgh-6_0Dh28YUiHW6_h-cc-ev92RkKiBKAJzlfN7eUndE0CsEw/exec';

        // --- Estado Global ---
        let allFaqs = [];
        let duplicateData = {};
        let currentRowToReplace = null;

        // --- Elementos del DOM (Generales) ---
        const loader = document.getElementById('loader');
        const resultDiv = document.getElementById('result');
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                e.currentTarget.classList.add('active');
                document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
                document.getElementById(e.currentTarget.dataset.view).classList.add('active');
                if (e.currentTarget.dataset.view === 'manage-view') {
                    loadAndRenderFaqs();
                }
            });
        });
        
        // --- Elementos del DOM (Vista Añadir) ---
        const generateBtn = document.getElementById('generateBtn');
        const refineBtn = document.getElementById('refineBtn');
        const addBtn = document.getElementById('addBtn');
        const replaceBtn = document.getElementById('replaceBtn');
        const discardBtn = document.getElementById('discardBtn');
        const bulkProcessBtn = document.getElementById('bulkProcessBtn');
        const categorizeOnlyCheckbox = document.getElementById('categorizeOnlyCheckbox');
        const reviewForm = document.getElementById('review-form');
        const duplicateAlert = document.getElementById('duplicate-alert');
        const reviewPregunta = document.getElementById('reviewPregunta');
        const reviewRespuesta = document.getElementById('reviewRespuesta');
        const markdownPreview = document.getElementById('markdown-preview');
        const refinementInput = document.getElementById('refinementInput');
        const categoriasContainer = document.getElementById('categoriasContainer');
        const addCategoriaInput = document.getElementById('addCategoriaInput');
        const palabrasClaveContainer = document.getElementById('palabrasClaveContainer');
        const addPalabraClaveInput = document.getElementById('addPalabraClaveInput');
        const existingQuestionDiv = document.getElementById('existing-question');
        const suggestedQuestionDiv = document.getElementById('suggested-question');
        const normalGenerationSection = document.getElementById('normal-generation-section');
        const categorizeOnlySection = document.getElementById('categorize-only-section');
        const userInput = document.getElementById('userInput');
        const categorizeQuestion = document.getElementById('categorize-question');
        const categorizeAnswer = document.getElementById('categorize-answer');
        const bulkInput = document.getElementById('bulkInput');

        // --- Elementos del DOM (Vista Gestionar) ---
        const searchInput = document.getElementById('searchInput');
        const faqListContainer = document.getElementById('faq-list-container');

        // --- Elementos del DOM (Modal Edición) ---
        const editModal = document.getElementById('edit-modal');
        const modalRowNumber = document.getElementById('modal-row-number');
        const modalPregunta = document.getElementById('modal-pregunta');
        const modalRespuesta = document.getElementById('modal-respuesta');
        const modalMarkdownPreview = document.getElementById('modal-markdown-preview');
        const modalCategoriasContainer = document.getElementById('modal-categorias-container');
        const modalAddCategoria = document.getElementById('modal-add-categoria');
        const modalPalabrasClaveContainer = document.getElementById('modal-palabrasclave-container');
        const modalAddPalabraClave = document.getElementById('modal-add-palabraclave');
        const modalSaveBtn = document.getElementById('modal-save');
        const modalCancelBtn = document.getElementById('modal-cancel');

        // --- Event Listeners ---
        generateBtn.addEventListener('click', handleGenerate);
        refineBtn.addEventListener('click', handleRefine);
        addBtn.addEventListener('click', handleSave);
        replaceBtn.addEventListener('click', handleReplace);
        discardBtn.addEventListener('click', handleDiscard);
        bulkProcessBtn.addEventListener('click', handleBulkProcess);
        categorizeOnlyCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            normalGenerationSection.style.display = isChecked ? 'none' : 'block';
            categorizeOnlySection.style.display = isChecked ? 'block' : 'none';
        });
        setupTagInput(addCategoriaInput, categoriasContainer);
        setupTagInput(addPalabraClaveInput, palabrasClaveContainer);
        reviewRespuesta.addEventListener('input', () => updateMarkdownPreview(reviewRespuesta.value, markdownPreview));
        searchInput.addEventListener('input', handleSearch);
        modalRespuesta.addEventListener('input', () => updateMarkdownPreview(modalRespuesta.value, modalMarkdownPreview));
        setupTagInput(modalAddCategoria, modalCategoriasContainer);
        setupTagInput(modalAddPalabraClave, modalPalabrasClaveContainer);
        modalCancelBtn.addEventListener('click', () => editModal.style.display = 'none');
        modalSaveBtn.addEventListener('click', handleModalSave);
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', (e) => {
                showTab(e.currentTarget.dataset.tab);
            });
        });

        // --- Manejadores de eventos (Vista Añadir) ---
        async function handleGenerate() {
            let payload;
            if (categorizeOnlyCheckbox.checked) {
                const question = categorizeQuestion.value.trim();
                const answer = categorizeAnswer.value.trim();
                if (!question || !answer) return showResult('Por favor, introduce la pregunta y la respuesta.', 'error');
                payload = { action: 'generate', pregunta: question, respuesta: answer, categorizeOnly: true };
            } else {
                const userText = userInput.value.trim();
                if (!userText) return showResult('Por favor, introduce un tema.', 'error');
                payload = { action: 'generate', userInput: userText, categorizeOnly: false };
            }
            currentRowToReplace = null;
            addBtn.textContent = 'Aprobar y Añadir a la Hoja de Cálculo';
            await callApi(payload);
        }
        async function handleBulkProcess() {
            const text = bulkInput.value.trim();
            if (!text) return showResult('El campo de texto para entrada múltiple está vacío.', 'error');
            const entries = text.split(/---\s*/);
            const qnaArray = [];
            for (const entry of entries) {
                if (!entry.trim()) continue;
                const match = entry.trim().match(/^[Pp]:\s*([\s\S]+?)\s*(\r\n|\n|\r)+\s*[Rr]:\s*([\s\S]+)$/);
                if (match && match[1] && match[3]) {
                    qnaArray.push({ pregunta: match[1].trim(), respuesta: match[3].trim() });
                }
            }
            if (qnaArray.length === 0) return showResult('No se encontraron entradas válidas. Asegúrate de usar el formato "P: ... R: ... ---".', 'error');
            await callApi({ action: 'bulkAdd', qnaArray });
        }
        async function handleRefine() {
            const refinementInstruction = refinementInput.value.trim();
            if (!refinementInstruction) return showResult('Por favor, introduce una instrucción para refinar.', 'error');
            const previousSuggestion = { Pregunta: reviewPregunta.value, Respuesta: reviewRespuesta.value, Categorias: getTagsAsString(categoriasContainer, ';'), PalabrasClave: getTagsAsString(palabrasClaveContainer, ',') };
            await callApi({ action: 'refine', previousSuggestion, refinementInstruction });
            refinementInput.value = '';
        }
        async function handleSave() {
            const faqData = { pregunta: reviewPregunta.value, respuesta: reviewRespuesta.value, categorias: getTagsAsString(categoriasContainer, ';'), palabrasClave: getTagsAsString(palabrasClaveContainer, ',') };
            let payload;
            if (currentRowToReplace) {
                payload = { action: 'replace', rowNumber: currentRowToReplace, faqData };
            } else {
                payload = { action: 'add', faqData };
            }
            await callApi(payload);
        }
        function handleReplace() {
            currentRowToReplace = duplicateData.existing.rowNumber;
            addBtn.textContent = `Aprobar y Reemplazar Fila ${currentRowToReplace}`;
            populateReviewForm(duplicateData.suggestion);
            hideAllSections();
            reviewForm.style.display = 'block';
        }
        function handleDiscard() {
            hideAllSections();
            showResult('Operación cancelada. La sugerencia ha sido descartada.', 'success');
        }

        // --- Manejadores de eventos (Vista Gestionar y Modal) ---
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            if (!searchTerm) {
                renderFaqList(allFaqs);
                return;
            }
            const filteredFaqs = allFaqs.filter(faq =>
                Object.values(faq).some(val => val.toString().toLowerCase().includes(searchTerm))
            );
            renderFaqList(filteredFaqs);
        }
        async function loadAndRenderFaqs() {
            setLoading(true);
            const result = await callApi({ action: 'getFaqs' });
            setLoading(false);
            if (result && result.success) {
                allFaqs = result.data.sort((a, b) => a.Pregunta.localeCompare(b.Pregunta));
                renderFaqList(allFaqs);
            }
        }
        async function handleModalSave() {
            const faqData = {
                pregunta: modalPregunta.value,
                respuesta: modalRespuesta.value,
                categorias: getTagsAsString(modalCategoriasContainer, ';'),
                palabrasClave: getTagsAsString(modalPalabrasClaveContainer, ',')
            };
            const rowNumber = modalRowNumber.value;
            setLoading(true);
            const result = await callApi({ action: 'updateFaq', rowNumber, faqData });
            setLoading(false);
            if (result && result.success) {
                editModal.style.display = 'none';
                showResult(result.message, 'success');
                loadAndRenderFaqs();
            }
        }
        async function handleDelete(rowNumber, question) {
            if (confirm(`¿Seguro que quieres borrar la pregunta "${question}"? Esta acción no se puede deshacer.`)) {
                setLoading(true);
                const result = await callApi({ action: 'deleteFaq', rowNumber });
                setLoading(false);
                if (result && result.success) {
                    showResult(result.message, 'success');
                    loadAndRenderFaqs();
                }
            }
        }

        // --- Lógica principal de la API ---
        async function callApi(payload) {
            setLoading(true);
            if (payload.action === 'generate' || payload.action === 'bulkAdd') hideAllSections();
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.success) {
                    handleSuccess(payload.action, result);
                } else {
                    showResult(result.message, 'error');
                }
                return result;
            } catch (error) {
                showResult('Error de conexión con el script: ' + error.message, 'error');
                return null;
            } finally {
                setLoading(false);
            }
        }

        function handleSuccess(action, result) {
            if (action === 'add' || action === 'replace' || action === 'bulkAdd') {
                showResult(result.message || 'Operación completada.', 'success');
                userInput.value = ''; categorizeQuestion.value = ''; categorizeAnswer.value = ''; bulkInput.value = '';
                currentRowToReplace = null;
                addBtn.textContent = 'Aprobar y Añadir a la Hoja de Cálculo';
            } else if (result.data && result.data.status === 'duplicate') {
                populateDuplicateAlert(result.data);
            } else {
                const suggestion = result.data.status === 'new' ? result.data.suggestion : result.data;
                populateReviewForm(suggestion);
            }
        }

        // --- Funciones de renderizado y UI ---
        function renderFaqList(faqs) {
            faqListContainer.innerHTML = '';
            if (faqs.length === 0) {
                faqListContainer.innerHTML = '<p>No se encontraron FAQs.</p>';
                return;
            }
            faqs.forEach(faq => {
                const item = document.createElement('div');
                item.className = 'faq-item';
                item.innerHTML = `<p>${faq.Pregunta}</p><div class="faq-item-buttons"><button>Editar</button><button class="delete">Borrar</button></div>`;
                item.querySelector('button').addEventListener('click', () => openEditModal(faq));
                item.querySelector('button.delete').addEventListener('click', () => handleDelete(faq.rowNumber, faq.Pregunta));
                faqListContainer.appendChild(item);
            });
        }
        function populateReviewForm(data) {
            reviewPregunta.value = data.Pregunta || '';
            reviewRespuesta.value = data.Respuesta || '';
            updateMarkdownPreview(reviewRespuesta.value, markdownPreview);
            clearContainer(categoriasContainer);
            (data.Categorias || '').split(/[,;]/).forEach(tag => createTag(tag, categoriasContainer));
            clearContainer(palabrasClaveContainer);
            (data.PalabrasClave || '').split(/[,;]/).forEach(tag => createTag(tag, palabrasClaveContainer));
            reviewForm.style.display = 'block';
        }
        function populateDuplicateAlert(data) {
            duplicateData = data;
            existingQuestionDiv.innerHTML = `<strong>P:</strong> ${data.existing.Pregunta}<br><strong>R:</strong> ${data.existing.Respuesta}`;
            suggestedQuestionDiv.innerHTML = `<strong>P:</strong> ${data.suggestion.Pregunta}<br><strong>R:</strong> ${data.suggestion.Respuesta}`;
            duplicateAlert.style.display = 'block';
        }
        function openEditModal(faq) {
            modalRowNumber.value = faq.rowNumber;
            modalPregunta.value = faq.Pregunta;
            modalRespuesta.value = faq.Respuesta;
            updateMarkdownPreview(modalRespuesta.value, modalMarkdownPreview);
            clearContainer(modalCategoriasContainer);
            (faq.Categorias || '').split(/[,;]/).forEach(tag => createTag(tag, modalCategoriasContainer));
            clearContainer(modalPalabrasClaveContainer);
            (faq.PalabrasClave || '').split(/[,;]/).forEach(tag => createTag(tag, modalPalabrasClaveContainer));
            editModal.style.display = 'flex';
        }
        function hideAllSections() {
            reviewForm.style.display = 'none';
            duplicateAlert.style.display = 'none';
            resultDiv.style.display = 'none';
        }
        function setLoading(isLoading) {
            loader.style.display = isLoading ? 'block' : 'none';
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = isLoading);
        }
        function showResult(message, type) {
            resultDiv.textContent = message;
            resultDiv.className = `result-message ${type}`;
            resultDiv.style.display = 'block';
            setTimeout(() => { resultDiv.style.display = 'none'; }, 4000);
        }
        function updateMarkdownPreview(markdownText, previewElement) {
            previewElement.innerHTML = marked.parse(markdownText);
        }
        function setupTagInput(inputElement, container) {
            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    createTag(inputElement.value, container);
                    inputElement.value = '';
                }
            });
        }
        function createTag(text, container) {
            const tagText = text.trim();
            if (!tagText) return;
            const tagEl = document.createElement('div');
            tagEl.className = 'tag';
            tagEl.innerHTML = `<span>${tagText}</span><span class="remove-tag" title="Eliminar">x</span>`;
            tagEl.querySelector('.remove-tag').addEventListener('click', () => tagEl.remove());
            container.appendChild(tagEl);
        }
        function getTagsAsString(container, separator) {
            return Array.from(container.querySelectorAll('.tag span:first-child')).map(t => t.textContent).join(separator);
        }
        function clearContainer(container) {
            container.innerHTML = '';
        }
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + '-entry-tab').classList.add('active');
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');
        }
    </script>
</body>
</html>
