<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <title>FAQ de la comunidad Vibe Coding Educativo</title>

  <script>
    tailwind = { config: { darkMode: 'class' } };
  </script>
  <script src="https://cdn.tailwindcss.com?v=3"></script>

  <script>
    (function () {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (isDark) document.documentElement.classList.add('dark');
    })();
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    body { font-family: 'Inter', sans-serif; }
    .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
    .dark .tab-button.active { border-color: #818cf8; color: #818cf8; background-color: #374151; }
    #loader { background-color: rgba(255,255,255,.8); backdrop-filter: blur(5px); }
    .dark #loader { background-color: rgba(17,24,39,.8); }
    .faq-item { transition: background-color .3s ease-in-out; }
    .faq-item[open] summary { font-weight:600; }
    .faq-item .answer-content { padding:.5rem 1rem 1rem; line-height:1.6; }
    .highlight { background:#fef3c7; color:#92400e; }
    .dark .highlight { background:#92400e; color:#fef3c7; }
    .ai-source { margin-top:1rem; padding-top:.75rem; border-top:1px solid #e5e7eb; font-size:.875rem; }
    .dark .ai-source { border-top-color:#374151; }
    .faq-highlighted { background:#fefce8!important; border-left:4px solid #eab308; }
    .dark .faq-highlighted { background:#4a441e!important; border-left-color:#facc15; }

    /* Estilos para el contenido Markdown */
    .answer-content ul, .answer-content ol {
      padding-left: 1.5rem;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .answer-content ul { list-style-type: disc; }
    .answer-content ol { list-style-type: decimal; }
    .answer-content li { margin-bottom: 0.25rem; }
    .answer-content a {
      color: #4f46e5;
      text-decoration: underline;
    }
    .dark .answer-content a { color: #818cf8; }
    .answer-content a:hover { text-decoration-thickness: 2px; }
    .answer-content code {
      background-color: #eef2ff;
      color: #3730a3;
      padding: 0.15rem 0.4rem;
      border-radius: 0.25rem;
      font-size: 0.9em;
    }
    .dark .answer-content code {
      background-color: #374151;
      color: #c7d2fe;
    }
    .answer-content pre {
      background-color: #f3f4f6;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      margin: 1rem 0;
    }
    .dark .answer-content pre { background-color: #1f2937; }
    .answer-content pre code {
      background-color: transparent;
      color: inherit;
      padding: 0;
      border-radius: 0;
    }
    .answer-content blockquote {
      border-left: 4px solid #d1d5db;
      padding-left: 1rem;
      margin-left: 0;
      font-style: italic;
      color: #6b7280;
    }
    .dark .answer-content blockquote {
      border-left-color: #4b5563;
      color: #9ca3af;
    }

  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200">
  <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center">
    <div class="w-16 h-16 border-4 border-gray-200 dark:border-gray-700 border-t-indigo-600 rounded-full animate-spin"></div>
    <p id="loader-text" class="mt-4 text-lg font-medium text-indigo-600 dark:text-indigo-400">Cargando preguntas...</p>
  </div>

  <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl relative">
    <header class="mb-6 text-center pt-10">
      <img src="faq.png" alt="Icono de la comunidad" class="w-20 h-20 mx-auto mb-4">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-white">
        Preguntas y respuestas (FAQ) de la comunidad <a href="https://vibe-coding-educativo.github.io/" target="_blank" rel="noopener noreferrer"
          class="text-indigo-600 hover:underline dark:text-indigo-400">Vibe Coding Educativo</a>
      </h1>
      <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">El centro de ayuda creado por y para la comunidad.</p>
    </header>

    <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
      <nav class="flex space-x-2 sm:space-x-4 justify-center" aria-label="tabs">
        <button id="tab-explore"
          class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500">
          Explorar FAQ
        </button>
        <button id="tab-ai"
          class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500">
          Pregunta a la IA
        </button>
      </nav>
    </div>

    <div>
      <div id="content-explore">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <input type="search" id="search" placeholder="Buscar por palabra clave..."
              class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
            <select id="category"
              class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
          </div>
          <div id="faq" class="space-y-2">
            <p class="text-center text-gray-500 dark:text-gray-400 p-8">Cargando contenido...</p>
          </div>
        </div>
      </div>

      <div id="content-ai" class="hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
          <h2 class="text-xl font-semibold mb-4 text-center dark:text-white">Asistente de Vibe Coding</h2>
          <div id="aiOut"
            class="mb-4 p-4 bg-indigo-50 dark:bg-gray-900 rounded-md min-h-[100px] text-gray-700 dark:text-gray-300 leading-relaxed">
            <p>Hola, soy tu asistente. Pregúntame cualquier duda que tengas sobre Vibe Coding y te responderé basándome en la información de esta FAQ.</p>
          </div>
          <div class="flex gap-2">
            <input type="text" id="aiIn" placeholder="Ej: ¿Cómo puedo usar mi propia API key?"
              class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
            <button id="aiBtn"
              class="px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition dark:bg-indigo-500 dark:hover:bg-indigo-600">Enviar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // === THEME ===
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.documentElement.classList.toggle('dark', e.matches);
    });

    // ===  APP ===
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz3mmQ8cWOwExcbRfK8SLPrOlh8jIeybEzdLqLVZbISlJM6W14VGrVBkHxb93QLVVqUkg/exec';
    const GEMINI_MODEL = 'gemini-1.5-flash-latest';

    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const tabExplore = document.getElementById('tab-explore');
    const tabAi = document.getElementById('tab-ai');
    const contentExplore = document.getElementById('content-explore');
    const contentAi = document.getElementById('content-ai');
    const search = document.getElementById('search');
    const category = document.getElementById('category');
    const faq = document.getElementById('faq');
    const aiIn = document.getElementById('aiIn');
    const aiBtn = document.getElementById('aiBtn');
    const aiOut = document.getElementById('aiOut');

    let apiKey = null;
    let allFaqs = [];
    const md = new showdown.Converter({
      tables: true,
      strikethrough: true,
      tasklists: true,
      simpleLineBreaks: true
    });

    // === BLOQUE NUEVO: HELPERS UNIVERSALES ===
    const normList = v =>
      Array.isArray(v) ? v : (v || '').split(/[;,|]/).map(s => s.trim()).filter(Boolean);

    const getCats = f => normList(f.categorías ?? f.categorias ?? f.Categorias);
    const getKws  = f => normList(f.palabras_clave ?? f.palabrasClave ?? f.Palabras_clave);
    // === FIN DEL BLOQUE NUEVO ===

    const showLoader = (on, text = 'Procesando...') => {
      loaderText.textContent = text;
      loader.style.display = on ? 'flex' : 'none';
    };

    const slugify = (t) => (t || '').toLowerCase().trim()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/\s+/g, '-').replace(/[^\w-]+/g, '').replace(/--+/g, '-')
      .replace(/^-+/, '').replace(/-+$/, '');

    const switchTab = (name) => {
      if (name === 'explore') {
        contentExplore.classList.remove('hidden');
        contentAi.classList.add('hidden');
        tabExplore.classList.add('active');
        tabAi.classList.remove('active');
      } else {
        contentExplore.classList.add('hidden');
        contentAi.classList.remove('hidden');
        tabExplore.classList.remove('active');
        tabAi.classList.add('active');
      }
    };

    const showAndHighlightFaq = (slug) => {
        const targetElement = document.getElementById(slug);
        if (targetElement) {
            switchTab('explore');
            document.querySelectorAll('.faq-highlighted').forEach(el => el.classList.remove('faq-highlighted'));
            
            targetElement.open = true;
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetElement.classList.add('faq-highlighted');
        }
    };

    const handleUrlHash = () => {
        const hash = window.location.hash.substring(1);
        if (hash) {
            setTimeout(() => showAndHighlightFaq(hash), 500);
        }
    };

    // === FUNCIÓN MODIFICADA ===
    const renderFaqs = (arr) => {
      faq.innerHTML = '';
      const activeFilter = category.value;

      if (!arr.length) {
        faq.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 p-8">Sin resultados.</p>';
        return;
      }
      const term = search.value.toLowerCase();
      arr.forEach(f => {
        const slug = slugify(f.pregunta);
        const details = document.createElement('details');
        details.id = slug;
        details.className = 'faq-item bg-gray-50 dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-700';
        
        const summary = document.createElement('summary');
        summary.className = 'p-4 font-medium text-gray-800 dark:text-gray-200 cursor-pointer list-inside';
        let q = f.pregunta || '';
        if (term) q = q.replace(new RegExp(term, 'gi'), m => `<span class="highlight">${m}</span>`);
        summary.innerHTML = q;
        
        const ans = document.createElement('div');
        ans.className = 'answer-content text-gray-700 dark:text-gray-300';

        // Contenedor para las etiquetas
        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'mb-4 flex flex-wrap gap-2';
        
        const allCategories = getCats(f);
        const visibleCategories = allCategories.filter(catName => activeFilter === 'all' || activeFilter !== catName);

        if (visibleCategories.length > 0) {
            visibleCategories.forEach(catName => {
                const tagButton = document.createElement('button');
                tagButton.textContent = catName;
                tagButton.className = 'text-xs font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300 px-2.5 py-1 rounded-full hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500';
                tagButton.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    category.value = catName;
                    filter();
                };
                tagsContainer.appendChild(tagButton);
            });
            // Añadir el contenedor de etiquetas al inicio del contenido de la respuesta
            ans.appendChild(tagsContainer);
        }

        // Contenedor para el texto de la respuesta
        const answerText = document.createElement('div');
        let a = md.makeHtml(f.respuesta || '');
        if (term) a = a.replace(new RegExp(term, 'gi'), m => `<span class="highlight">${m}</span>`);
        answerText.innerHTML = a;
        ans.appendChild(answerText);

        const shareContainer = document.createElement('div');
        shareContainer.className = 'mt-4 pt-3 border-t border-gray-200 dark:border-gray-600 flex justify-end items-center';
        const shareButton = document.createElement('button');
        shareButton.className = 'text-sm font-medium text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 transition-colors flex items-center';
        shareButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg> Compartir`;
        shareButton.onclick = (e) => {
            e.preventDefault();
            const shareUrl = `${window.location.origin}${window.location.pathname}#${slug}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                const originalText = shareButton.innerHTML;
                shareButton.textContent = '¡Enlace copiado!';
                setTimeout(() => { shareButton.innerHTML = originalText; }, 2000);
            });
        };
        shareContainer.appendChild(shareButton);
        ans.appendChild(shareContainer);

        details.append(summary, ans);
        faq.append(details);
      });
    };

    const populateCats = () => {
        const catCounts = {};
        allFaqs.forEach(f => {
            const cats = getCats(f);
            cats.forEach(c => {
                catCounts[c] = (catCounts[c] || 0) + 1;
            });
        });

        category.innerHTML = '<option value="all">Todas las categorías</option>';
        const sortedCats = Object.keys(catCounts).sort();

        sortedCats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = `${c} (${catCounts[c]})`;
            category.append(opt);
        });
    };

    const filter = () => {
      let arr = allFaqs;
      const cat  = category.value;
      const term = search.value.toLowerCase();

      if (cat !== 'all') arr = arr.filter(f => getCats(f).includes(cat));

      if (term) arr = arr.filter(f =>
        (f.pregunta  || '').toLowerCase().includes(term) ||
        (f.respuesta || '').toLowerCase().includes(term) ||
        getCats(f).join(' ').toLowerCase().includes(term) ||
        getKws(f).join(' ').toLowerCase().includes(term)
      );

      renderFaqs(arr);
    };

    const fetchScript = async (action, data = {}) => {
      try {
        const r = await fetch(SCRIPT_URL, {
          method: 'POST', mode: 'cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action, data })
        });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return await r.json();
      } catch (e) { console.error(e); return null; }
    };

    const callGemini = async (prompt, schema = null) => {
      if (!apiKey) throw new Error('Sin API Key');
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
      const payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }] };
      if (schema) payload.generationConfig = { responseMimeType: 'application/json', responseSchema: schema };
      const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const json = await res.json();
      if (json.candidates?.length) {
        return schema ? JSON.parse(json.candidates[0].content.parts[0].text)
          : json.candidates[0].content.parts[0].text;
      }
      throw new Error('Respuesta inesperada');
    };

    const handleAI = async () => {
        const q = aiIn.value.trim();
        if (!q) { aiOut.innerHTML = '<p class="text-red-600">Escribe una pregunta.</p>'; return; }
        aiOut.innerHTML = '<p>Pensando...</p>';
        aiBtn.disabled = true;

        const ctx = allFaqs.map(f => `Pregunta: ${f.pregunta}\nRespuesta: ${f.respuesta}`).join('\n\n---\n\n');
        const prompt = `Eres un asistente experto en Vibe Coding educativo. Responde a la pregunta del usuario basándote *únicamente* en la siguiente base de conocimientos (FAQ). No inventes información. Si la respuesta no se encuentra en la FAQ, responde amablemente que no tienes esa información. Tu respuesta debe estar en dos partes: primero la respuesta directa a la pregunta del usuario, y segundo, una lista de las **preguntas exactas** de la FAQ que has usado como fuentes.

--- BASE DE CONOCIMIENTOS (FAQ) ---
${ctx}
--- FIN DE LA BASE DE CONOCIMIENTOS ---

PREGUNTA DEL USUARIO: "${q}"
`;
        const schema = { type: 'OBJECT', properties: { respuesta: { type: 'STRING' }, fuentes: { type: 'ARRAY', items: { type: 'STRING' } } }, required: ['respuesta', 'fuentes'] };

        try {
            const r = await callGemini(prompt, schema);
            
            if (!r.fuentes || r.fuentes.length === 0) {
                aiOut.innerHTML = `<p>No he encontrado una respuesta en la base de conocimientos para tu pregunta. Prueba a reformularla con otras palabras.</p>`;
                return;
            }

            const div = document.createElement('div');
            div.innerHTML = md.makeHtml(r.respuesta);

            const sourceContainer = document.createElement('div');
            sourceContainer.className = 'ai-source';
            sourceContainer.innerHTML = '<strong class="dark:text-gray-200">Fuentes consultadas:</strong>';
            const sourceList = document.createElement('ul');
            sourceList.className = 'list-disc pl-5 mt-2 space-y-1';
            r.fuentes.forEach(sourceText => {
                const slug = slugify(sourceText);
                const originalFaq = allFaqs.find(f => slugify(f.pregunta) === slug);
                if (originalFaq) {
                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = `#${slug}`;
                    link.textContent = originalFaq.pregunta;
                    link.className = 'text-indigo-600 hover:underline dark:text-indigo-400 dark:hover:text-indigo-300 cursor-pointer';
                    link.onclick = (e) => {
                        e.preventDefault();
                        showAndHighlightFaq(slug);
                    };
                    listItem.appendChild(link);
                    sourceList.appendChild(listItem);
                }
            });
            sourceContainer.appendChild(sourceList);
            div.appendChild(sourceContainer);

            aiOut.innerHTML = '';
            aiOut.append(div);
        } catch (e) {
            aiOut.innerHTML = '<p class="text-red-600">Error: ' + e.message + '</p>';
        } finally {
            aiBtn.disabled = false;
            aiIn.value = '';
        }
    };

    const init = () => {
        showLoader(true, 'Cargando contenido...');
        fetchScript('getData')
            .then(d => {
                if (d?.status === 'success') {
                    allFaqs = d.data.map(f => {
                        const cats = getCats(f);
                        const kws = getKws(f);
                        return { ...f, categorías: cats, categorias: cats, palabras_clave: kws };
                    });

                    tabExplore.textContent = `Explorar FAQ (${allFaqs.length})`;
                    renderFaqs(allFaqs);
                    populateCats();
                    handleUrlHash();
                    return fetchScript('getApiKey');
                }
                throw new Error(d?.message || 'No se pudo cargar la FAQ');
            })
            .then(k => {
                if (k?.status === 'success') apiKey = k.apiKey;
                else throw new Error(k?.message || 'Sin API Key');
            })
            .catch(e => {
                faq.innerHTML = '<p class="text-center text-red-600 p-8">' + e.message + '</p>';
            })
            .finally(() => showLoader(false));
    };

    tabExplore.onclick = () => switchTab('explore');
    
    // === LÓGICA MODIFICADA ===
    tabAi.onclick = () => {
      let filtersChanged = false;
      if (category.value !== 'all') {
        category.value = 'all';
        filtersChanged = true;
      }
      if (search.value !== '') {
        search.value = '';
        filtersChanged = true;
      }
      
      if (filtersChanged) {
        filter();
      }
      
      switchTab('ai');
    };

    search.oninput = filter;
    category.onchange = filter;
    aiBtn.onclick = handleAI;
    aiIn.addEventListener('keyup', e => { if (e.key === 'Enter') handleAI(); });
    window.addEventListener('hashchange', handleUrlHash);

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
