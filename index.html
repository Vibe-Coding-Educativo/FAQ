<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de FAQ Asistido por IA</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 2rem; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 0.5rem; }
        p { text-align: center; margin-top: 0; color: #666; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: bold; margin-bottom: 0.5rem; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; margin-top: 0.5rem; }
        button:active { transform: scale(0.98); }
        #generateBtn { background-color: #3498db; color: white; }
        #refineBtn { background-color: #f39c12; color: white; }
        #addBtn { background-color: #2ecc71; color: white; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #review-form, #duplicate-alert { display: none; margin-top: 2rem; border-top: 2px solid #eee; padding-top: 2rem; }
        .loader { text-align: center; margin: 1.5rem 0; display: none; }
        .result-message { text-align: center; padding: 1rem; margin-top: 1rem; border-radius: 4px; display: none; }
        .result-message.success { background-color: #e6f4ea; color: #2d6a4f; }
        .result-message.error { background-color: #fbe9e7; color: #c62828; }
        .tag-input-container { display: flex; gap: 0.5rem; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 0.5rem; min-height: 40px; }
        .tag { display: flex; align-items: center; background-color: #e0e0e0; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; }
        .tag .remove-tag { margin-left: 8px; cursor: pointer; font-weight: bold; }
        #userInput, #categorize-question, #categorize-answer { height: 120px; resize: vertical; }
        .markdown-editor-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        #reviewRespuesta { height: 300px; resize: vertical; }
        #markdown-preview { border: 1px solid #ccc; border-radius: 4px; padding: 10px; height: 300px; overflow-y: auto; background-color: #fafafa; }
        #markdown-preview * { text-align: left !important; }
        .refine-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px dashed #ccc;}
        .checkbox-group { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; } /* Margen inferior para separar */
        .checkbox-group label { margin-bottom: 0; font-weight: normal; }
        #duplicate-alert { background-color: #fffbe6; border-color: #ffe58f; padding: 1.5rem; border-radius: 8px; border: 1px solid #ffe58f; }
        .duplicate-content { border: 1px solid #ddd; padding: 1rem; margin-top: 0.5rem; border-radius: 4px; background-color: #fff; }
        .duplicate-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; }
        #categorize-only-section { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Editor de FAQ</h1>
        <p>Introduce un tema y la IA te propondrá una entrada para que la revises.</p>

        <div id="generate-section">
            <!-- INICIO DE LA CORRECCIÓN DE ORDEN -->
            <div class="checkbox-group">
                <input type="checkbox" id="categorizeOnlyCheckbox">
                <label for="categorizeOnlyCheckbox">Mantener mi texto y solo añadir categorías/palabras clave</label>
            </div>
            <!-- FIN DE LA CORRECCIÓN DE ORDEN -->

            <div id="normal-generation-section">
                <div class="form-group">
                    <label for="userInput">Idea o tema a desarrollar:</label>
                    <textarea id="userInput" placeholder="Escribe aquí una idea general para que la IA la desarrolle..."></textarea>
                </div>
            </div>
            <div id="categorize-only-section">
                <div class="form-group">
                    <label for="categorize-question">Pregunta (texto final):</label>
                    <textarea id="categorize-question"></textarea>
                </div>
                <div class="form-group">
                    <label for="categorize-answer">Respuesta (texto final):</label>
                    <textarea id="categorize-answer"></textarea>
                </div>
            </div>
            
            <button id="generateBtn">Generar Sugerencia</button>
        </div>

        <div class="loader" id="loader">🧠 Pensando...</div>

        <div id="duplicate-alert">
            <h2>⚠️ Posible Duplicado Encontrado</h2>
            <p>La IA cree que tu idea es muy similar a una pregunta que ya existe.</p>
            <div class="form-group">
                <label>Pregunta Existente:</label>
                <div class="duplicate-content" id="existing-question"></div>
            </div>
            <div class="form-group">
                <label>Nueva Sugerencia de la IA:</label>
                <div class="duplicate-content" id="suggested-question"></div>
            </div>
            <p>¿Qué quieres hacer?</p>
            <div class="duplicate-buttons">
                <button id="replaceBtn">Revisar y Reemplazar</button>
                <button id="discardBtn" style="background-color: #e74c3c;">Dejar la antigua (descartar sugerencia)</button>
            </div>
        </div>

        <div id="review-form">
            <h2>Revisa la sugerencia de la IA</h2>
            <div class="form-group">
                <label for="reviewPregunta">Pregunta</label>
                <input type="text" id="reviewPregunta">
            </div>
            <div class="form-group">
                <label for="reviewRespuesta">Respuesta (compatible con Markdown)</label>
                <div class="markdown-editor-container">
                    <textarea id="reviewRespuesta"></textarea>
                    <div id="markdown-preview"></div>
                </div>
            </div>
            <div class="form-group">
                <label for="addCategoriaInput">Categorías</label>
                <div class="tag-input-container">
                    <input type="text" id="addCategoriaInput" placeholder="Añadir y pulsar Enter...">
                </div>
                <div class="tag-container" id="categoriasContainer"></div>
            </div>
            <div class="form-group">
                <label for="addPalabraClaveInput">Palabras Clave</label>
                 <div class="tag-input-container">
                    <input type="text" id="addPalabraClaveInput" placeholder="Añadir y pulsar Enter...">
                </div>
                <div class="tag-container" id="palabrasClaveContainer"></div>
            </div>
            <div class="refine-section">
                <div class="form-group">
                    <label for="refinementInput">¿Quieres mejorar algo? Da una instrucción:</label>
                    <input type="text" id="refinementInput" placeholder="Ej: 'haz la respuesta más corta', 'usa un tono más formal', 'añade un ejemplo de código'">
                </div>
                <button id="refineBtn">Refinar con IA</button>
            </div>
            <button id="addBtn">Aprobar y Añadir a la Hoja de Cálculo</button>
        </div>
        
        <div id="result" class="result-message"></div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyuUrtNb72Faij5gp7qtgh-6_0Dh28YUiHW6_h-cc-ev92RkKiBKAJzlfN7eUndE0CsEw/exec';

        // --- Elementos del DOM ---
        const generateBtn = document.getElementById('generateBtn');
        const refineBtn = document.getElementById('refineBtn');
        const addBtn = document.getElementById('addBtn');
        const replaceBtn = document.getElementById('replaceBtn');
        const discardBtn = document.getElementById('discardBtn');
        const loader = document.getElementById('loader');
        const resultDiv = document.getElementById('result');
        const categorizeOnlyCheckbox = document.getElementById('categorizeOnlyCheckbox');
        const reviewForm = document.getElementById('review-form');
        const duplicateAlert = document.getElementById('duplicate-alert');
        const reviewPregunta = document.getElementById('reviewPregunta');
        const reviewRespuesta = document.getElementById('reviewRespuesta');
        const markdownPreview = document.getElementById('markdown-preview');
        const refinementInput = document.getElementById('refinementInput');
        const categoriasContainer = document.getElementById('categoriasContainer');
        const addCategoriaInput = document.getElementById('addCategoriaInput');
        const palabrasClaveContainer = document.getElementById('palabrasClaveContainer');
        const addPalabraClaveInput = document.getElementById('addPalabraClaveInput');
        const existingQuestionDiv = document.getElementById('existing-question');
        const suggestedQuestionDiv = document.getElementById('suggested-question');
        const normalGenerationSection = document.getElementById('normal-generation-section');
        const categorizeOnlySection = document.getElementById('categorize-only-section');
        const userInput = document.getElementById('userInput');
        const categorizeQuestion = document.getElementById('categorize-question');
        const categorizeAnswer = document.getElementById('categorize-answer');

        // --- Variables de estado ---
        let duplicateData = {};
        let currentRowToReplace = null;

        // --- Event Listeners ---
        generateBtn.addEventListener('click', handleGenerate);
        refineBtn.addEventListener('click', handleRefine);
        addBtn.addEventListener('click', handleSave);
        replaceBtn.addEventListener('click', handleReplace);
        discardBtn.addEventListener('click', handleDiscard);
        
        categorizeOnlyCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            normalGenerationSection.style.display = isChecked ? 'none' : 'block';
            categorizeOnlySection.style.display = isChecked ? 'block' : 'none';
        });

        setupTagInput(addCategoriaInput, categoriasContainer);
        setupTagInput(addPalabraClaveInput, palabrasClaveContainer);
        reviewRespuesta.addEventListener('input', () => updateMarkdownPreview(reviewRespuesta.value));

        // --- Manejadores de eventos ---
        async function handleGenerate() {
            let payload;
            if (categorizeOnlyCheckbox.checked) {
                const question = categorizeQuestion.value.trim();
                const answer = categorizeAnswer.value.trim();
                if (!question || !answer) return showResult('Por favor, introduce la pregunta y la respuesta.', 'error');
                payload = { action: 'generate', pregunta: question, respuesta: answer, categorizeOnly: true };
            } else {
                const userText = userInput.value.trim();
                if (!userText) return showResult('Por favor, introduce un tema.', 'error');
                payload = { action: 'generate', userInput: userText, categorizeOnly: false };
            }
            
            currentRowToReplace = null;
            addBtn.textContent = 'Aprobar y Añadir a la Hoja de Cálculo';
            await callApi(payload);
        }

        async function handleRefine() {
            const refinementInstruction = refinementInput.value.trim();
            if (!refinementInstruction) return showResult('Por favor, introduce una instrucción para refinar.', 'error');
            const previousSuggestion = { Pregunta: reviewPregunta.value, Respuesta: reviewRespuesta.value, Categorias: getTagsAsString(categoriasContainer, ';'), PalabrasClave: getTagsAsString(palabrasClaveContainer, ',') };
            await callApi({ action: 'refine', previousSuggestion, refinementInstruction });
            refinementInput.value = '';
        }
        
        async function handleSave() {
            const faqData = { pregunta: reviewPregunta.value, respuesta: reviewRespuesta.value, categorias: getTagsAsString(categoriasContainer, ';'), palabrasClave: getTagsAsString(palabrasClaveContainer, ',') };
            let payload;
            if (currentRowToReplace) {
                payload = { action: 'replace', rowNumber: currentRowToReplace, faqData };
            } else {
                payload = { action: 'add', faqData };
            }
            await callApi(payload);
        }

        function handleReplace() {
            currentRowToReplace = duplicateData.existing.rowNumber;
            addBtn.textContent = `Aprobar y Reemplazar Fila ${currentRowToReplace}`;
            populateReviewForm(duplicateData.suggestion);
            hideAllSections();
            reviewForm.style.display = 'block';
        }

        function handleDiscard() {
            hideAllSections();
            showResult('Operación cancelada. La sugerencia ha sido descartada.', 'success');
        }

        // --- Lógica principal de la API ---
        async function callApi(payload) {
            setLoading(true);
            hideAllSections();
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.success) {
                    handleSuccess(payload.action, result);
                } else {
                    showResult(result.message, 'error');
                }
            } catch (error) {
                showResult('Error de conexión con el script: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        function handleSuccess(action, result) {
            if (action === 'add' || action === 'replace') {
                showResult(result.message || 'Operación completada con éxito.', 'success');
                userInput.value = '';
                categorizeQuestion.value = '';
                categorizeAnswer.value = '';
                currentRowToReplace = null;
                addBtn.textContent = 'Aprobar y Añadir a la Hoja de Cálculo';
            } else if (result.data && result.data.status === 'duplicate') {
                populateDuplicateAlert(result.data);
            } else {
                const suggestion = result.data.status === 'new' ? result.data.suggestion : result.data;
                populateReviewForm(suggestion);
            }
        }

        // --- Funciones de renderizado y UI ---
        function populateReviewForm(data) {
            reviewPregunta.value = data.Pregunta || '';
            reviewRespuesta.value = data.Respuesta || '';
            updateMarkdownPreview(reviewRespuesta.value);
            
            clearContainer(categoriasContainer);
            // --- INICIO DE LA CORRECCIÓN ---
            // Se usa una expresión regular para dividir por coma O por punto y coma.
            (data.Categorias || '').split(/[,;]/).forEach(tag => createTag(tag, categoriasContainer));
            
            clearContainer(palabrasClaveContainer);
            (data.PalabrasClave || '').split(/[,;]/).forEach(tag => createTag(tag, palabrasClaveContainer));
            // --- FIN DE LA CORRECCIÓN ---

            reviewForm.style.display = 'block';
        }

        function populateDuplicateAlert(data) {
            duplicateData = data;
            existingQuestionDiv.innerHTML = `<strong>P:</strong> ${data.existing.Pregunta}<br><strong>R:</strong> ${data.existing.Respuesta}`;
            suggestedQuestionDiv.innerHTML = `<strong>P:</strong> ${data.suggestion.Pregunta}<br><strong>R:</strong> ${data.suggestion.Respuesta}`;
            duplicateAlert.style.display = 'block';
        }

        function hideAllSections() {
            reviewForm.style.display = 'none';
            duplicateAlert.style.display = 'none';
            resultDiv.style.display = 'none';
        }

        function setLoading(isLoading) {
            loader.style.display = isLoading ? 'block' : 'none';
            generateBtn.disabled = isLoading;
            refineBtn.disabled = isLoading;
            addBtn.disabled = isLoading;
            replaceBtn.disabled = isLoading;
            discardBtn.disabled = isLoading;
        }

        function showResult(message, type) {
            resultDiv.textContent = message;
            resultDiv.className = `result-message ${type}`;
            resultDiv.style.display = 'block';
        }
        
        function updateMarkdownPreview(markdownText) {
            markdownPreview.innerHTML = marked.parse(markdownText);
        }

        function setupTagInput(inputElement, container) {
            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    createTag(inputElement.value, container);
                    inputElement.value = '';
                }
            });
        }

        function createTag(text, container) {
            const tagText = text.trim();
            if (!tagText) return;
            const tagEl = document.createElement('div');
            tagEl.className = 'tag';
            tagEl.innerHTML = `<span>${tagText}</span><span class="remove-tag" title="Eliminar">x</span>`;
            tagEl.querySelector('.remove-tag').addEventListener('click', () => {
                tagEl.remove();
            });
            container.appendChild(tagEl);
        }

        function getTagsAsString(container, separator) {
            const tags = container.querySelectorAll('.tag span:first-child');
            return Array.from(tags).map(t => t.textContent).join(separator);
        }

        function clearContainer(container) {
            container.innerHTML = '';
        }
    </script>
</body>
</html>
