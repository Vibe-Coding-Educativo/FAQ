<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de FAQ Asistido por IA</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 2rem; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 0.5rem; }
        p { text-align: center; margin-top: 0; color: #666; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-weight: bold; margin-bottom: 0.5rem; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; margin-top: 0.5rem; }
        button:active { transform: scale(0.98); }
        #generateBtn { background-color: #3498db; color: white; }
        #refineBtn { background-color: #f39c12; color: white; } /* Botón de refinar */
        #addBtn { background-color: #2ecc71; color: white; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #review-form { display: none; margin-top: 2rem; border-top: 2px solid #eee; padding-top: 2rem; }
        .loader { text-align: center; margin: 1.5rem 0; display: none; }
        .result-message { text-align: center; padding: 1rem; margin-top: 1rem; border-radius: 4px; display: none; }
        .result-message.success { background-color: #e6f4ea; color: #2d6a4f; }
        .result-message.error { background-color: #fbe9e7; color: #c62828; }
        .tag-input-container { display: flex; gap: 0.5rem; }
        .tag-input-container input { flex-grow: 1; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-top: 0.5rem; min-height: 40px; }
        .tag { display: flex; align-items: center; background-color: #e0e0e0; color: #333; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; }
        .tag .remove-tag { margin-left: 8px; cursor: pointer; font-weight: bold; color: #555; }
        #userInput { height: 120px; resize: vertical; }
        .markdown-editor-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        #reviewRespuesta { height: 300px; resize: vertical; }
        #markdown-preview { border: 1px solid #ccc; border-radius: 4px; padding: 10px; height: 300px; overflow-y: auto; background-color: #fafafa; }
        #markdown-preview * { text-align: left !important; }
        #markdown-preview h1, #markdown-preview h2, #markdown-preview h3 { margin-top: 0; }
        #markdown-preview code { background-color: #eee; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        #markdown-preview pre { background-color: #eee; padding: 1rem; border-radius: 4px; overflow-x: auto; }
        #markdown-preview blockquote { border-left: 3px solid #ccc; padding-left: 1rem; margin-left: 0; color: #666; }
        .refine-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px dashed #ccc;}
    </style>
</head>
<body>
    <div class="container">
        <h1>Editor de FAQ</h1>
        <p>Introduce un tema y la IA te propondrá una entrada para que la revises.</p>

        <div id="generate-section">
            <div class="form-group">
                <label for="userInput">Idea o tema a desarrollar:</label>
                <textarea id="userInput" placeholder="Ej: 'cómo usar fetch para leer un CSV' o 'diferencias entre GET y POST'"></textarea>
            </div>
            <button id="generateBtn">Generar Sugerencia</button>
        </div>

        <div class="loader" id="loader">🧠 Pensando...</div>

        <div id="review-form">
            <h2>Revisa la sugerencia de la IA</h2>
            <div class="form-group">
                <label for="reviewPregunta">Pregunta</label>
                <input type="text" id="reviewPregunta">
            </div>
            <div class="form-group">
                <label for="reviewRespuesta">Respuesta (compatible con Markdown)</label>
                <div class="markdown-editor-container">
                    <textarea id="reviewRespuesta"></textarea>
                    <div id="markdown-preview"></div>
                </div>
            </div>
            <div class="form-group">
                <label for="addCategoriaInput">Categorías</label>
                <div class="tag-input-container">
                    <input type="text" id="addCategoriaInput" placeholder="Añadir y pulsar Enter...">
                </div>
                <div class="tag-container" id="categoriasContainer"></div>
            </div>
            <div class="form-group">
                <label for="addPalabraClaveInput">Palabras Clave</label>
                 <div class="tag-input-container">
                    <input type="text" id="addPalabraClaveInput" placeholder="Añadir y pulsar Enter...">
                </div>
                <div class="tag-container" id="palabrasClaveContainer"></div>
            </div>

            <!-- NUEVA SECCIÓN DE REFINADO -->
            <div class="refine-section">
                <div class="form-group">
                    <label for="refinementInput">¿Quieres mejorar algo? Da una instrucción:</label>
                    <input type="text" id="refinementInput" placeholder="Ej: 'haz la respuesta más corta', 'usa un tono más formal', 'añade un ejemplo de código'">
                </div>
                <button id="refineBtn">Refinar con IA</button>
            </div>
            
            <button id="addBtn">Aprobar y Añadir a la Hoja de Cálculo</button>
        </div>
        
        <div id="result" class="result-message"></div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyuUrtNb72Faij5gp7qtgh-6_0Dh28YUiHW6_h-cc-ev92RkKiBKAJzlfN7eUndE0CsEw/exec';

        const generateBtn = document.getElementById('generateBtn');
        const refineBtn = document.getElementById('refineBtn'); // Nuevo botón
        const addBtn = document.getElementById('addBtn');
        const userInput = document.getElementById('userInput');
        const loader = document.getElementById('loader');
        const reviewForm = document.getElementById('review-form');
        const resultDiv = document.getElementById('result');

        const reviewPregunta = document.getElementById('reviewPregunta');
        const reviewRespuesta = document.getElementById('reviewRespuesta');
        const markdownPreview = document.getElementById('markdown-preview');
        const refinementInput = document.getElementById('refinementInput'); // Nuevo campo
        
        const categoriasContainer = document.getElementById('categoriasContainer');
        const addCategoriaInput = document.getElementById('addCategoriaInput');
        const palabrasClaveContainer = document.getElementById('palabrasClaveContainer');
        const addPalabraClaveInput = document.getElementById('addPalabraClaveInput');

        generateBtn.addEventListener('click', handleGenerate);
        refineBtn.addEventListener('click', handleRefine); // Nuevo evento
        addBtn.addEventListener('click', handleAdd);

        setupTagInput(addCategoriaInput, categoriasContainer);
        setupTagInput(addPalabraClaveInput, palabrasClaveContainer);
        
        reviewRespuesta.addEventListener('input', () => updateMarkdownPreview(reviewRespuesta.value));

        async function handleGenerate() {
            if (!userInput.value.trim()) return showResult('Por favor, introduce un tema.', 'error');
            await callApi({ action: 'generate', userInput: userInput.value });
        }

        async function handleRefine() {
            const refinementInstruction = refinementInput.value.trim();
            if (!refinementInstruction) return showResult('Por favor, introduce una instrucción para refinar.', 'error');
            
            const previousSuggestion = {
                Pregunta: reviewPregunta.value,
                Respuesta: reviewRespuesta.value,
                Categorias: getTagsAsString(categoriasContainer, ';'),
                PalabrasClave: getTagsAsString(palabrasClaveContainer, ',')
            };

            await callApi({ action: 'refine', previousSuggestion, refinementInstruction });
            refinementInput.value = ''; // Limpiar el campo después de usarlo
        }

        async function handleAdd() {
            const faqData = {
                pregunta: reviewPregunta.value,
                respuesta: reviewRespuesta.value,
                categorias: getTagsAsString(categoriasContainer, ';'),
                palabrasClave: getTagsAsString(palabrasClaveContainer, ',')
            };
            await callApi({ action: 'add', faqData });
        }

        async function callApi(payload) {
            setLoading(true, payload.action);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.success) {
                    if (payload.action === 'add') {
                        showResult(result.message, 'success');
                        reviewForm.style.display = 'none';
                        userInput.value = '';
                    } else {
                        populateReviewForm(result.data);
                    }
                } else {
                    showResult(result.message, 'error');
                }
            } catch (error) {
                showResult('Error de conexión con el script: ' + error.message, 'error');
            } finally {
                setLoading(false, payload.action);
            }
        }

        function populateReviewForm(data) {
            reviewPregunta.value = data.Pregunta || '';
            reviewRespuesta.value = data.Respuesta || '';
            updateMarkdownPreview(reviewRespuesta.value);
            clearContainer(categoriasContainer);
            (data.Categorias || '').split(';').forEach(tag => createTag(tag, categoriasContainer));
            clearContainer(palabrasClaveContainer);
            (data.PalabrasClave || '').split(',').forEach(tag => createTag(tag, palabrasClaveContainer));
            reviewForm.style.display = 'block';
        }
        
        function updateMarkdownPreview(markdownText) { markdownPreview.innerHTML = marked.parse(markdownText); }
        function setupTagInput(inputElement, container) { inputElement.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); createTag(inputElement.value, container); inputElement.value = ''; } }); }
        function createTag(text, container) { const tagText = text.trim(); if (!tagText) return; const tagEl = document.createElement('div'); tagEl.className = 'tag'; tagEl.innerHTML = `<span>${tagText}</span><span class="remove-tag" title="Eliminar">x</span>`; tagEl.querySelector('.remove-tag').addEventListener('click', () => tagEl.remove()); container.appendChild(tagEl); }
        function getTagsAsString(container, separator) { return Array.from(container.querySelectorAll('.tag span:first-child')).map(t => t.textContent).join(separator); }
        function clearContainer(container) { container.innerHTML = ''; }
        function setLoading(isLoading, action) {
            loader.style.display = isLoading ? 'block' : 'none';
            generateBtn.disabled = isLoading;
            refineBtn.disabled = isLoading;
            addBtn.disabled = isLoading;
            if (isLoading) resultDiv.style.display = 'none';
        }
        function showResult(message, type) { resultDiv.textContent = message; resultDiv.className = `result-message ${type}`; resultDiv.style.display = 'block'; }
    </script>
</body>
</html>
