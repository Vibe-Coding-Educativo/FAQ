<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FAQ de la comunidad Vibe Coding Educativo</title>

  <script>
    tailwind = { config: { darkMode: 'class' } };
  </script>
  <script src="https://cdn.tailwindcss.com?v=3"></script>

  <script>
    (function () {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (isDark) document.documentElement.classList.add('dark');
    })();
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    body { font-family: 'Inter', sans-serif; }
    .tab-button.active { border-color: #4f46e5; color: #4f46e5; background-color: #eef2ff; }
    .dark .tab-button.active { border-color: #818cf8; color: #818cf8; background-color: #374151; }
    #loader { background-color: rgba(255,255,255,.8); backdrop-filter: blur(5px); }
    .dark #loader { background-color: rgba(17,24,39,.8); }
    .faq-item { transition: background-color .3s ease-in-out; }
    .faq-item[open] summary { font-weight:600; }
    .faq-item .answer-content { padding:.5rem 1rem 1rem; line-height:1.6; }
    .highlight { background:#fef3c7; color:#92400e; }
    .dark .highlight { background:#92400e; color:#fef3c7; }
    .ai-source { margin-top:1rem; padding-top:.75rem; border-top:1px solid #e5e7eb; font-size:.875rem; }
    .dark .ai-source { border-top-color:#374151; }
    .faq-highlighted { background:#eef2ff!important; border-left:4px solid #4f46e5; }
    .dark .faq-highlighted { background:#3730a3!important; border-left-color:#818cf8; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-200">
  <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center">
    <div class="w-16 h-16 border-4 border-gray-200 dark:border-gray-700 border-t-indigo-600 rounded-full animate-spin"></div>
    <p id="loader-text" class="mt-4 text-lg font-medium text-indigo-600 dark:text-indigo-400">Cargando preguntas...</p>
  </div>

  <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl relative">
    <header class="mb-6 text-center pt-10">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-white">
        FAQ de la comunidad <a href="https://vibe-coding-educativo.github.io/" target="_blank" rel="noopener noreferrer"
          class="text-indigo-600 hover:underline dark:text-indigo-400">Vibe Coding Educativo</a>
      </h1>
      <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">El centro de ayuda creado por y para la comunidad.</p>
    </header>

    <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
      <nav class="flex space-x-2 sm:space-x-4 justify-center" aria-label="tabs">
        <button id="tab-explore"
          class="tab-button active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500">
          Explorar FAQ
        </button>
        <button id="tab-ai"
          class="tab-button whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm sm:text-base text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500">
          Preguntar a la IA
        </button>
      </nav>
    </div>

    <div>
      <div id="content-explore">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <input type="search" id="search" placeholder="Buscar por palabra clave..."
              class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
            <select id="category"
              class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
          </div>
          <div id="faq" class="space-y-2">
            <p class="text-center text-gray-500 dark:text-gray-400 p-8">Cargando contenido...</p>
          </div>
        </div>
      </div>

      <div id="content-ai" class="hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
          <h2 class="text-xl font-semibold mb-4 text-center dark:text-white">Asistente de Vibe Coding</h2>
          <div id="aiOut"
            class="mb-4 p-4 bg-indigo-50 dark:bg-gray-900 rounded-md min-h-[100px] text-gray-700 dark:text-gray-300 leading-relaxed">
            <p>Hola, soy tu asistente...</p>
          </div>
          <div class="flex gap-2">
            <input type="text" id="aiIn" placeholder="Ej: ¿Cómo puedo usar mi propia API key?"
              class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
            <button id="aiBtn"
              class="px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition dark:bg-indigo-500 dark:hover:bg-indigo-600">Enviar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // === THEME ===
    // Reacciona a cambios en el tema del SO mientras la página está abierta.
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.documentElement.classList.toggle('dark', e.matches);
    });

    // ===  RESTO DE LA APP (abreviado) ===
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz3mmQ8cWOwExcbRfK8SLPrOlh8jIeybEzdLqLVZbISlJM6W14VGrVBkHxb93QLVVqUkg/exec';
    const GEMINI_MODEL = 'gemini-2.5-flash-lite';

    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const tabExplore = document.getElementById('tab-explore');
    const tabAi = document.getElementById('tab-ai');
    const contentExplore = document.getElementById('content-explore');
    const contentAi = document.getElementById('content-ai');
    const search = document.getElementById('search');
    const category = document.getElementById('category');
    const faq = document.getElementById('faq');
    const aiIn = document.getElementById('aiIn');
    const aiBtn = document.getElementById('aiBtn');
    const aiOut = document.getElementById('aiOut');

    let apiKey = null;
    let allFaqs = [];
    const md = new showdown.Converter();

    const showLoader = (on, text='Procesando...') => {
      loaderText.textContent = text;
      loader.style.display = on ? 'flex' : 'none';
    };

    const slugify = (t) => t.toLowerCase().trim()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/\s+/g,'-').replace(/[^\w-]+/g,'').replace(/--+/g,'-')
      .replace(/^-+/, '').replace(/-+$/, '');

    const switchTab = (name) => {
      if(name==='explore'){ contentExplore.classList.remove('hidden'); contentAi.classList.add('hidden'); tabExplore.classList.add('active'); tabAi.classList.remove('active'); }
      else { contentExplore.classList.add('hidden'); contentAi.classList.remove('hidden'); tabExplore.classList.remove('active'); tabAi.classList.add('active'); }
    };

    const renderFaqs = (arr) => {
      faq.innerHTML = '';
      if(!arr.length){
        faq.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 p-8">Sin resultados.</p>';
        return;
      }
      const term = search.value.toLowerCase();
      arr.forEach(f => {
        const slug = slugify(f.pregunta);
        const details = document.createElement('details');
        details.id = slug;
        details.className = 'faq-item bg-gray-50 dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-700 cursor-pointer';
        const summary = document.createElement('summary');
        summary.className = 'p-4 font-medium text-gray-800 dark:text-gray-200';
        let q = f.pregunta || '';
        if(term) q = q.replace(new RegExp(term,'gi'), m=>`<span class="highlight">${m}</span>`);
        summary.innerHTML = q;
        const ans = document.createElement('div');
        ans.className = 'answer-content text-gray-700 dark:text-gray-300';
        let a = md.makeHtml(f.respuesta||'');
        if(term) a = a.replace(new RegExp(term,'gi'), m=>`<span class="highlight">${m}</span>`);
        ans.innerHTML = a;
        details.append(summary, ans);
        faq.append(details);
      });
    };

    const populateCats = () => {
      const set = new Set();
      allFaqs.forEach(f => (f.categorías||[]).forEach(c=>set.add(c)));
      category.innerHTML = '<option value="all">Todas las categorías</option>';
      [...set].sort().forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c; opt.textContent=c;
        category.append(opt);
      });
    };

    const filter = () => {
      let arr = allFaqs;
      const cat = category.value;
      const term = search.value.toLowerCase();
      if(cat!=='all') arr = arr.filter(f => (f.categorías||[]).includes(cat));
      if(term) arr = arr.filter(f =>
        (f.pregunta||'').toLowerCase().includes(term)||
        (f.respuesta||'').toLowerCase().includes(term)||
        (f.categorías||[]).join(' ').toLowerCase().includes(term)||
        (f.palabras_clave||[]).join(' ').toLowerCase().includes(term)
      );
      renderFaqs(arr);
    };

    const fetchScript = async (action, data={}) => {
      try{
        const r = await fetch(SCRIPT_URL, {
          method:'POST', mode:'cors',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify({action, data})
        });
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.json();
      }catch(e){ console.error(e); return null;}
    };

    const callGemini = async (prompt, schema=null)=>{
      if(!apiKey) throw new Error('Sin API Key');
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
      const payload = { contents:[{role:'user', parts:[{text:prompt}]}] };
      if(schema) payload.generationConfig = { responseMimeType:'application/json', responseSchema:schema };
      const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const json = await res.json();
      if(json.candidates?.length){
        return schema ? JSON.parse(json.candidates[0].content.parts[0].text)
                      : json.candidates[0].content.parts[0].text;
      }
      throw new Error('Respuesta inesperada');
    };

    const handleAI = async ()=>{
      const q = aiIn.value.trim();
      if(!q){ aiOut.innerHTML='<p class="text-red-600">Escribe una pregunta.</p>'; return;}
      aiOut.innerHTML='<p>Pensando...</p>'; aiBtn.disabled=true;
      const ctx = allFaqs.map(f=>`Pregunta: ${f.pregunta}\nRespuesta: ${f.respuesta}`).join('\n\n---\n\n');
      const prompt = `Eres un asistente...\n--- BASE ---\n${ctx}\n--- FIN ---\nPREGUNTA: "${q}"`;
      const schema = {type:'OBJECT',properties:{respuesta:{type:'STRING'},fuentes:{type:'ARRAY',items:{type:'STRING'}}},required:['respuesta','fuentes']};
      try{
        const r = await callGemini(prompt, schema);
        const div = document.createElement('div');
        div.innerHTML = md.makeHtml(r.respuesta);
        aiOut.innerHTML='';
        aiOut.append(div);
      }catch(e){
        aiOut.innerHTML = '<p class="text-red-600">Error: '+e.message+'</p>';
      }finally{
        aiBtn.disabled=false; aiIn.value='';
      }
    };

    const init = ()=>{
      showLoader(true,'Cargando contenido...');
      fetchScript('getData')
        .then(d=>{
          if(d?.status==='success'){ allFaqs=d.data; renderFaqs(allFaqs); populateCats(); return fetchScript('getApiKey'); }
          throw new Error(d?.message||'No se pudo cargar la FAQ');
        })
        .then(k=>{
          if(k?.status==='success') apiKey=k.apiKey;
          else throw new Error(k?.message||'Sin API Key');
        })
        .catch(e=>{
          faq.innerHTML = '<p class="text-center text-red-600 p-8">'+e.message+'</p>';
        })
        .finally(()=> showLoader(false));
    };

    tabExplore.onclick = ()=>switchTab('explore');
    tabAi.onclick = ()=>switchTab('ai');
    search.oninput = filter;
    category.onchange = filter;
    aiBtn.onclick = handleAI;
    aiIn.addEventListener('keyup', e=>{ if(e.key==='Enter') handleAI(); });

    document.addEventListener('DOMContentLoaded', init);

    // DEBUG helpers:
    window._debugTheme = ()=>({ hasDark: document.documentElement.classList.contains('dark'), twMode: tailwind.config?.darkMode });
  </script>
</body>
</html>
